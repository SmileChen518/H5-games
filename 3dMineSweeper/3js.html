<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style>canvas { width: 100%; height: 100% }</style>
    <script src="js/three.js"></script>
    <script src='js/stats.js'></script>
    <script src='js/TrackballControls.js'></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/WebGL.js"></script>
</head>
<body>
	<script>
		var stats, renderer, camera, scene, light, group, geometry, materials, controls, sound, loader, orbControl;
		var _tNum, _tBtns, _iTotal, _iRow, _iMineCount, _bWin;
		function initParas(){
			materials = []; //0按钮，1地雷，2旗帜，3-11数字0-8，12炸弹，13绿旗，14播放
			var material = new THREE.MeshBasicMaterial();
			for (var i = 0; i < 5; i++) for (var j = 0; j < 3; j++){
				var mat = material.clone();
				mat.map = new THREE.TextureLoader().load( 'textures/grids.png' );
				mat.map.offset = new THREE.Vector2(0.33*j, 0.8-0.2*i);
				mat.map.repeat = new THREE.Vector2(.33, .2);
				materials.push(mat);
			}

			_iRow = 9;
			_iTotal = 81;
			_tNum = [];
			_tBtns = [];
			_iMineCount = 10;
			_bWin = false;
		}
		function initStat() {
        	stats = new Stats();
			stats.setMode(0); // 0: fps, 1: ms
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.left = '0px';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );
        }
		function initRederer(){
			renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
		}
		function initCamera(){
			camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
			// camera = new THREE.OrthographicCamera( window.innerWidth / - 2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / - 2, 10, 1000 );
			camera.position.set( 0, 0, 100 );
		}
		function initScene(){
			scene = new THREE.Scene();
		}
		function initListener () {
			var listener = new THREE.AudioListener();
			camera.add(listener);
			sound = new THREE.Audio(listener);
			sound.setVolume(0.5);
			loader = new THREE.AudioLoader();
		}
        function initLight() {
        	// light = new THREE.AmbientLight(0x00FF00);
        	// scene.add(light);
            light = new THREE.DirectionalLight(0xFFFFFF, 1, 0);
            light.position.set(0, 1, 1);
            // scene.add(light);
            // light = new THREE.PointLight(0x0000FF);
            // light.position.set(0, 0, 100);
            scene.add(light);
        }
        // 扫雷格子
		function initGroup(){
			group = new THREE.Group();
			var LENGTH = 10, COUNT = 9, INTER = 0, OFFSET = (LENGTH+INTER)*(COUNT-1)/2; 
			geometry = new THREE.CubeGeometry( LENGTH, LENGTH, LENGTH );
			mesh = new THREE.Mesh( geometry, materials[0] );
			mesh.position.set(-OFFSET, OFFSET, 0);
			group.add(mesh);
			for (var i = 0; i < COUNT; i++) for (var j = 0; j < COUNT; j++) for (var z = 0; z < 1; z++){
				if (i == 0 && j == 0 && z == 0) continue;
				var temp = mesh.clone();
				temp.position.set((LENGTH+INTER)*j-OFFSET, -(LENGTH+INTER)*i+OFFSET, (LENGTH+INTER)*z);
				group.add(temp);
			}

			//menus
			var geo = new THREE.CubeGeometry( 20, 10, 0 );
        	var me = new THREE.Mesh( geo, materials[14] );
        	group.add(me);
        	me.position.set(0, -OFFSET-15, 0);

        	scene.add( group );
		}
		function initGrid(){
            var helper = new THREE.GridHelper( 1000, 50 );
            helper.rotation.x = Math.PI/2;
            scene.add( helper );
        }
		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}
		function animate() {
			renderer.render( scene, camera );
			requestAnimationFrame( animate );
			// stats.update();
		}
		function init(){
			initParas();
			// initStat();
			initRederer();
			initCamera();
			initScene();
			initListener();
			// initLight();
			initOrbControls();
			initGrid(); //显示网格
			initGroup();
			animate();
			addEventListener('click', onMouseClick, false);
			window.addEventListener( 'resize', onWindowResize, false );
			onStart();
			// showBtns();
		}
		function playSound (s) {
			loader.load( 'audio/'+s+'.mp3', function( buf ) {
			    sound.setBuffer( buf );
			    sound.play();
			});
		}
		function onStart(){
			_bWin = false;
			_tNum = [];
	        // _tFlag = [];
	        _tBtns = [];
			initMines();
			showBtns(true);
		}
		// 鼠标双击触发的方法
	    function onMouseClick(event) {
	        // 获取 raycaster 和所有模型相交的数组，其中的元素按照距离排序，越近的越靠前
	        var intersects = getIntersects(event);

	        // 获取选中最近的 Mesh 对象
	        if (intersects.length != 0 && intersects[0].object instanceof THREE.Mesh) {
	        	var obj = intersects[0].object;
	            var idx = group.children.indexOf(obj);
	            // console.log("idx = ", idx);
	            if (idx == _iTotal) {
	            	playSound("click");
	            	onStart();
	            } else if (!_bWin) {
		            if (_tNum[idx] == -1){ //地雷
		            	playSound("bomb");
						obj.material = materials[12];
		            	_bWin = true;
		            } else {
		            	showGrids(idx, []);
		            	showBtns();
		            	_bWin = checkWin();
		            	if (_bWin) playSound("win");
				    	else playSound("check");
		            }
	            }
	            
	        }
	    }
	    // 获取与射线相交的对象数组
	    function getIntersects(event) {
	        event.preventDefault();

	        // 声明 raycaster 和 mouse 变量
	        var raycaster = new THREE.Raycaster();
	        var mouse = new THREE.Vector2();

	        // 通过鼠标点击位置,计算出 raycaster 所需点的位置,以屏幕为中心点,范围 -1 到 1
	        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
	        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

	        //通过鼠标点击的位置(二维坐标)和当前相机的矩阵计算出射线位置
	        raycaster.setFromCamera(mouse, camera);

	        //获取group下的mesh
	        var scensObjs = [];
		    scene.children.forEach(child => {
			    for (var i = 0; i < child.children.length; i++) {
			      var obj=child.children[i];
			      scensObjs.push(obj);
			    }
		    });
		    // 获取与射线相交的对象数组，其中的元素按照距离排序，越近的越靠前
	        var intersects = raycaster.intersectObjects(scensObjs);

	        //返回选中的对象
	        return intersects;
	    }

	    // 初始化轨迹球控件
	    function initOrbControls() {
	        orbControl = new THREE.OrbitControls(camera, renderer.domElement);
	        orbControl.minDistance = 25;
			orbControl.maxDistance = 1000;
	    }
		function initMines(){
			var tNum = [];
	        var tMineNum = [];
	        for (var i = 0; i < _iTotal; i++) {
	            tNum.push(i);
	            tMineNum[i] = 0;
	            _tNum[i] = 0;
	            // _tFlag[i] = 0;
	            _tBtns[i] = 1;
	        };
            for (var i = 0; i < _iMineCount; i++) {
                var iRandom = Math.floor(Math.random() * (tNum.length - 1));
                var iNum = tNum.splice(iRandom, 1);
                tMineNum[iNum] = 1;
            };
	        for (var k = 0; k < _iTotal; k++) {
	            if (tMineNum [k] == 1) {
	                _tNum[k] = -1;
	                var col = k % _iRow;
					var row = Math.floor(k / _iRow);
					for (var i = row-1; i < row+2; i++) for (var j = col-1; j < col+2; j++) {
						if (i > -1 && j > -1 && i < _iRow && j < _iRow){
							var idx = i*_iRow+j;
							if (_tNum[idx] != -1) _tNum[idx]++;
						}
					};
	            }
	        };
		}
		function showGrids(idx, t){
	        var iLabNum = _tNum [idx];
	        if (iLabNum != -1) {
	            _tBtns[idx] = 0;
	            if (iLabNum == 0) {
	            	var col = idx % _iRow;
					var row = Math.floor(idx / _iRow);
					for (var i = row-1; i < row+2; i++) for (var j = col-1; j < col+2; j++) {
						if (i > -1 && j > -1 && i < _iRow && j < _iRow){
							var k = i*_iRow+j;
							if (_tBtns[k] == 1 && !t.includes(k)){
								t.push(k);
								showGrids(k, t);
							}
						}
					};
	            }
	        }
	    }
	    function showBtns (b) {
	    	for (var i = 0; i < _tBtns.length; i++) {
	    		if (_tBtns[i] == 0) group.children[i].material = materials[3+_tNum[i]];
	    		else if (b) group.children[i].material = materials[0];
	    	};
	    }
	    function checkWin () {
	    	for (var i = 0; i < _tBtns.length; i++) 
	    		if (_tBtns[i] == 1 && _tNum[i] != -1) return false;
	    	return true;
	    }
		init();
    </script>
</body>
</html>
